---
title: "R-Ladies Meetups"
author: "Augustina Ragwitz"
date: "November 28, 2017"
output: 
  html_document:
    toc: true
params:
  meetup_api_key: !r Sys.getenv("API_KEY_MEETUP_RLADIES")
  archive_folder: !r Sys.Date()
  output_folder: "latest"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(ggplot2)
library(httr)
library(jsonlite)
library(lubridate)
library(maps)
library(purrr)
library(readr)
library(reshape2)
library(stringr)
library(tidyr)
```

# Overview

R-Ladies has developed a package called MeetupR to streamline Meetup analysis. The goal of this notebook is to call the Meetup API directly to document API calls and parameters, then compare the results to the MeetupR implementation. If there are possible improvements then patches will be proposed!

Additionally it would be great to have a dynamic dashboard that shows Meetup stats so we can get the latest and greatest for conference presentations.

## Repo Link

https://github.com/rladies-pdx/meetup-analysis

# Data Collection

## Meetup API Setup

```{r globals}
dir.create(file.path(params$output_folder))

get_meetups <- function (url, query) {
  req <- GET(url, query=query)
  print(paste(req$url))
  json <- content(req, as = "text")
  things <- fromJSON(json, flatten=TRUE)
  return(things)
}
```

## Meetup Groups

Identifying Meetup groups should be straightforward because R-Ladies exists as a Meetup topic. Unfortunately not every group is using this topic. This uses the "find_groups" function from the Meetup API.

```{r find_groups}

get_rladies_groups <- function (folder) {
  
  groups_url <- "https://api.meetup.com/find/groups"

  groups_query_params <- list(
    key=params$meetup_api_key, 
    sign=TRUE,
    page=200,
    radius="global")
  
  # by topic
  meetup_groups_topic <- get_meetups(groups_url, append(groups_query_params, c(topic_id=1513883, order="members")))
  
  # by text + category
  meetup_groups_text <- get_meetups(groups_url, append(groups_query_params, c(text="r-ladies", category=34)))
  
  meetup_groups_aggr <- bind_rows(meetup_groups_topic, meetup_groups_text %>% anti_join(meetup_groups_topic, by="id"))
  meetup_groups <- meetup_groups_aggr %>% filter(str_detect(name, "[Rr]([ -]?)[Ll]adies"))
  
  meetup_groups <- meetup_groups %>%
    mutate(events_url = paste("https://api.meetup.com/", urlname, "/events", sep="")) %>%
    select(-meta_category.category_ids) # remove lists
  
  write_csv(meetup_groups, paste(folder, "rladies_meetup_groups.csv", sep="/"), 
            na = "")
  write_csv(meetup_groups_topic %>% select(-meta_category.category_ids), 
            paste(folder, "rladies_meetup_groups_topic.csv", sep="/"), 
            na = "")
  write_csv(meetup_groups_text %>% select(-meta_category.category_ids), 
            paste(folder, "rladies_meetup_groups_text.csv", sep="/"), 
            na = "")
  return(meetup_groups)
}

```

I created an account and subscribed it to the found groups. This checks that it is subscribed to all current groups. A future version of this should attempt to join via the Meetup API (depends on join questions).

```{r self_groups}

get_self_groups <- function (folder) {
  
  groups_url <- "https://api.meetup.com/self/groups"

  groups_query_params <- list(
    key=params$meetup_api_key, 
    sign=TRUE,
    page=200,
    fields="approved")
  
  self_groups <- get_meetups(groups_url, groups_query_params)
  
  self_groups <- self_groups %>%
    mutate(events_url = paste("https://api.meetup.com/", urlname, "/events", sep="")) %>%
    select(-meta_category.category_ids) # remove lists
  
  write_csv(self_groups, paste(folder, "rladies_self_groups.csv", sep="/"), 
            na = "")
  
  return(self_groups)
}

```


## Group Members

Names and other common identifying information about members has been removed. We are only interested in identifying unique members across groups and events, not who they are.

```{r group_members, eval=FALSE}

# get_rladies_members <- function (meetup_groups, folder)

folder <- params$archive_folder
  
  members_query_params <- list(
    key=params$meetup_api_key, 
    sign=TRUE,
    page=200,
    fields=paste("memberships", "topics", "gender", sep=",") # these can only go with individual profile calls
  )
  
  dir.create(file.path(paste(folder, "rladies_members", sep="/")))
  
  meetup_members <- data_frame()
  
  for (n in 1:nrow(meetup_groups)) {
    members_url <- str_replace(meetup_groups[n,]["events_url"], "events", "members")
    num_members <- as.numeric(meetup_groups[n,]["members"])
    for (i in 1:ceiling(num_members/200)) {
      print(paste("Trying url:", members_url))
      members <- get_meetups(members_url, append(members_query_params, c(offset=i)))
  
      if(length(members)== 0) {
        next()
      }
      
      # remove identifying info
      members <- members %>%
        select(-name)
      
      members$group_profile.answers <- NULL

      meetup_members <- bind_rows(meetup_members, members)
      write_csv(meetup_members, 
                paste0(folder, "/rladies_members/_meetup_members_", n, ".csv"),
                na = "")
    }
  }
  
  # remove identifying info
  meetup_members <- meetup_members %>% 
    select(-group_profile.intro, -bio, -email, -group_profile.title)

  write_csv(meetup_members, paste(folder, "rladies_meetup_members.csv", sep="/"), 
            na = "")

```

## Upcoming Events

### Calendar

Depends on querying account being a member of the meetups.

```{r self_calendar}

get_rladies_calendar <- function (folder) {
  calendar_url <- "https://api.meetup.com/self/calendar"
  
  events_query_params <- list(
    key=params$meetup_api_key, 
    sign=TRUE,
    page=200,
    order="time",
    radius="global")
  
  get_events <- function (url, query) {
    req <- GET(url, query=query)
    print(paste(req$url))
    json <- content(req, as = "text")
    events <- fromJSON(json, flatten=TRUE)
    return(events)
  }

  meetup_events_calendar <- get_events(calendar_url, events_query_params)
  
  write_csv(meetup_events_calendar, paste(folder, "rladies_meetup_calendar.csv", sep="/"), 
            na = "")
  return(meetup_events_calendar)
}

```

### Per Group Query

Per group query - note that this gets throttled so here it is limited to groups the querying account does not have membership to.

```{r group_events_future}

get_rladies_future <- function (meetup_groups, folder) {

  future_events_query_params <- list(
    key=params$meetup_api_key, 
    sign=TRUE,
    page=200,
    status="upcoming",
    fields=paste("comment_count", "photo_album", sep=", ")
  )
  
  dir.create(file.path(paste(folder, "rladies_meetup_events", sep="/")))
  
  meetup_events_future <- data_frame()
  
  for (n in 1:nrow(meetup_groups)) {
    events_url <- meetup_groups[n,]["events_url"]
    print(paste("Trying url:", events_url$events_url))
    meetups <- get_meetups(events_url$events_url, future_events_query_params)
  
    if(length(meetups)== 0) {
      next()
    }
  
    meetups <- meetups %>% mutate(photo_album.photo_sample=NA)
    meetup_events_future <- bind_rows(meetup_events_future, meetups)
    write_csv(meetup_events_future, 
              paste0(folder, "/rladies_meetup_events/_meetup_events_future_", n, ".csv"),
              na = "")
  }
  
  write_csv(meetup_events_future, paste(folder, "rladies_meetup_events_future.csv", sep="/"), 
            na = "")
  return(meetup_events_future)
}
```


### Upcoming Events Endpoint

Meetup provides an upcoming_events endpoint that is convenient but may not be comprehensive. Let's use it and compare our results to the group by group approach above.

```{r upcoming_events}

get_rladies_upcoming <- function (folder) {
  find_upcoming_url <- "https://api.meetup.com/find/upcoming_events"
  
  # change to get upcoming meetups for all meetups in the list
  events_query_params <- list(
    key=params$meetup_api_key, 
    sign=TRUE,
    page=200,
    order="time",
    radius="global")
  
  get_group_events <- function (url, query) {
    req <- GET(url, query=query)
    print(paste(req$url))
    json <- content(req, as = "text")
    groups <- fromJSON(json, flatten=TRUE)
    return(groups$events)
  }
  
  # I tried "topic" but no R-Ladies results were returned, so this field doesn't apply
  meetup_events_text <- get_group_events(find_upcoming_url, append(events_query_params, c(text="rladies")))
  
  # just in case anything slipped in there
  meetup_events_upcoming <- meetup_events_text %>% filter(str_detect(group.name, "[Rr](-?)[Ll]adies"))
                                            
  write_csv(meetup_events_upcoming, paste(folder, "rladies_meetup_upcoming_events.csv", sep="/"), 
            na = "")
  
  return(meetup_events_upcoming)
}

```

## Past Events

Get all past events for all groups. This call is expensive and gets throttled.

```{r group_events_past, eval=FALSE}

# TODO this currently throttles out and has to be manipulated manually to run
get_rladies_past_all <- function (folder) {}

folder=params$archive_folder
meetup_groups <- read_csv(paste(folder, "rladies_meetup_groups.csv", sep="/"))

past_events_query_params <- list(
  key=params$meetup_api_key, 
  sign=TRUE,
  page=200,
  status="past",
  fields=paste("comment_count", "photo_album", sep=", ")
)

dir.create(file.path(paste(folder, "rladies_meetup_events", sep="/")))

meetup_events_past <- data_frame()

for (n in 1:nrow(meetup_groups)) {
  events_url <- meetup_groups[n,]["events_url"]
  print(paste("Trying url:", events_url$events_url))
  meetups <- get_meetups(events_url$events_url, past_events_query_params)
  if(length(meetups)== 0) {
    next()
  }

  meetups <- meetups %>% mutate(photo_album.photo_sample=NA)
  meetup_events_past <- bind_rows(meetup_events_past, meetups)
  write_csv(meetup_events_past, paste0(folder, "/rladies_meetup_events/_meetup_events_past_", n, ".csv"),
            na = "")
}

write_csv(meetup_events_past, paste(folder,"rladies_meetup_events_past.csv", sep="/"), 
          na = "")

# copy entire archive folder to latest, don't try to manage individual file updates
system2("rm", args = c("-r", params$output_folder))
system2("cp", args = c("-R", paste(params$archive_folder), paste(params$output_folder)))

```

Combine the previous past events pull for a group with the previous upcoming events pull where the event has occurred in the past. If all previous upcoming events occurred in the past, then we'll need to pull past events for the group depending on the time interval.

Check this against the updated group list to find any groups that need all events pulled. Only pull all events for those groups.

```{r group_events_past_v2}

get_rladies_past <- function() {
  # TODO
}

```

## Get Latest

Create a new archive folder and get the latest data.

```{r get_latest_data, eval=FALSE}

dir.create(file.path(params$archive_folder))

# TODO add try/catch for throttling
meetup_groups <- get_rladies_groups(params$archive_folder)
self_groups <- get_self_groups(params$archive_folder)

pending_groups <- meetup_groups %>% 
  anti_join(self_groups, by="id")

get_rladies_upcoming(params$archive_folder)
meetup_events_calendar <- get_rladies_calendar(params$archive_folder)
meetup_events_future <- get_rladies_future(pending_groups, params$archive_folder)

meetup_events_current <- bind_rows(meetup_events_future, meetup_events_calendar)
write_csv(meetup_events_current, paste(params$archive_folder,"rladies_meetup_events_current.csv", sep="/"), 
          na = "")

```

```{r copy_archive_to_latest, eval=FALSE}

system2("rm", args = c("-r", params$output_folder))
system2("cp", args = c("-R", paste(params$archive_folder), paste(params$output_folder)))

```


# Meetup Groups

```{r meetup_groups, message=FALSE}
meetup_groups <- read_csv(paste(params$output_folder, "rladies_meetup_groups.csv", sep="/"))
```

## Group Membership Check

Check group membership for the retrieval account.

```{r check_self_groups, message=FALSE}
self_groups <- read_csv(paste(params$output_folder, "rladies_self_groups.csv", sep="/"))

 pending_groups <- meetup_groups %>% 
  anti_join(self_groups, by="id") %>% 
  select(id, name, join_mode, link, events_url) %>%
  arrange(join_mode)
```

All Pending Groups:

```{r pending_groups}
pending_groups
```

Pending Groups Not Requiring Approval:

```{r pending_groups_approval}
pending_groups %>% filter(join_mode != "approval")
```

## Topic R-Ladies

```{r find_group_by_topic, message=FALSE}
meetup_groups_topic <- read_csv(paste(params$output_folder, "rladies_meetup_groups_topic.csv", sep="/"))
```

## Text search "R-Ladies"

A text search for "rladies" did not return any results. Including the tech category id (34) excludes extra results.

```{r find_group_by_text, message=FALSE}
meetup_groups_text <- read_csv(paste(params$output_folder, "rladies_meetup_groups_text.csv", sep="/"))
```

## R-Ladies Missing Topic

Naughty groups!

```{r groups_missing_topic}

# group + organizer to contact
meetups_missing_topic <- meetup_groups_text %>% anti_join(meetup_groups_topic, by="id")

meetups_missing_topic %>% filter(str_detect(name, "[Rr]([ -]?)[Ll]adies")) %>%
  arrange(-members) %>% 
  select(name, localized_location, organizer.name, members, created)

```

# Meetup Members

Membership numbers only show the current totals. To track membership over time we need to see when members joined the group. Additionally, we are interested in discovering repeat RSVPs as well as common group membership.

# Meetup Activity

Identifying which groups are regularly scheduling Meetups will help us to see who is the most active. Groups with gaps in Meetup activity or with no events should be highlighted so we can reach out to their organizers. 

## Past Events

```{r read_past_events, message=FALSE}
meetup_events_past <- read_csv(paste(params$output_folder,"rladies_meetup_events_past.csv", sep="/"))

meetup_groups <- read_csv(paste(params$output_folder, "rladies_meetup_groups.csv", sep="/"))

meetup_events_past_merge <- meetup_events_past %>% 
  inner_join(meetup_groups %>% 
               select(urlname, city, country, state, members, timezone),
             by=c("group.urlname"="urlname")) %>%
  separate(timezone, c("region"), extra="drop", fill="left")

meetup_events_past_merge <- meetup_events_past_merge %>%
  mutate(
    group.created=as.POSIXct(group.created/1000, tz="UTC", origin="1970-01-01"),
    created=as.POSIXct(created/1000, tz="UTC", origin="1970-01-01"))
```

## Event Frequency

How many events has each meetup had?

```{r past_events_freq}
past_events_freq <- meetup_events_past_merge %>% 
  group_by(group.name) %>% 
  summarise(num_events=n(),
            lat=first(group.lat), lon=first(group.lon), 
            location=first(group.localized_location),
            country=first(country),
            state=first(state),
            city=first(city),
            members=first(members),
            region=first(region)) %>%
  mutate(num_events_log = round(log(num_events))) %>%
  group_by(num_events_log) %>%
  mutate(events_min_max = ifelse(min(num_events) == max(num_events), 
                                 paste(min(num_events)),
                                 paste(min(num_events), "-", max(num_events))))

```

```{r past_events_freq_hist}

ggplot(past_events_freq, aes(x=reorder(location, num_events), y=num_events)) +
  geom_bar(stat="identity", aes(fill=region)) +
  coord_flip()

```


```{r past_events_freq_map, eval=FALSE}

# TODO: error when using maps - Error: ggplot2 doesn't know how to deal with data of class list

```

## Event Frequency Density

```{r}
ggplot(past_events_freq, aes(x=reorder(events_min_max, num_events_log))) + 
  geom_density() +
  xlab("Events per Meetup (Log)")
```

## Meetup Age by First Event

What is the "age" of meetups based on their first event?

```{r meetup_first_event, message=FALSE, warning=FALSE}

past_event_age <- meetup_events_past_merge %>%
  group_by(group.name) %>%
  summarise(first_meetup = as_datetime(min(local_date, na.rm=FALSE)),
            location=first(group.localized_location),
            region=first(region),
            group.created=first(group.created))  %>%
  mutate(first_meetup_age=difftime(as_datetime("2017-12-01"), first_meetup, unit="days"),
         location=reorder(location, first_meetup_age))
```

```{r meetup_first_event_plot}

ggplot(past_event_age, aes(x=location, y=first_meetup_age)) +
  geom_bar(stat="identity", aes(fill=region)) +
  coord_flip() +
  scale_y_continuous(breaks = pretty(past_event_age$first_meetup_age, n = 10)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("R-Ladies City") +
  ylab("Days Since First Meetup")


```

## First Meetup vs Created

```{r first_meetup_vs_created, message=FALSE, warning=FALSE}

created_vs_first <- past_event_age %>%
  mutate(
    group_age = difftime(as_datetime("2017-12-01"), group.created, units="days"),
    created_interval=difftime(first_meetup, group.created, units="days"),
    location=reorder(location, -created_interval))

ggplot(created_vs_first, aes(x=location, y=created_interval)) +
  geom_bar(stat="identity", aes(fill=region)) +
  coord_flip()

```

```{r, message=FALSE, warning=FALSE}
created_vs_first_melt <- created_vs_first %>% 
  mutate(location=reorder(location,group_age)) %>%
  select(location, group_age, created_interval) %>% 
  melt()

ggplot(created_vs_first_melt, aes(x=location, y=value)) +
  geom_bar(stat="identity", aes(fill=variable)) +
  coord_flip()
```

## Event Interval

How much time passes between the Meetup events? Are some groups regularly meeting every month? What is the typical time interval between Meetup groups?

```{r event_interval}

event_intervals <- meetup_events_past_merge %>%
  group_by(group.name) %>%
  arrange(local_date) %>%
  mutate(
    prev_event = lag(local_date),
    days_between = difftime(local_date, prev_event, unit="days")
  ) %>%
  select(group.name, group.localized_location, region, days_between, local_date, prev_event, id)

```

```{r event_interval_plot}

event_intervals_curr <- event_intervals %>% filter(local_date > as_datetime("2016-01-01"))

ggplot(event_intervals_curr, aes(x=local_date, y=days_between)) +
  geom_bar(stat="identity", position="dodge", aes(fill=group.localized_location), show.legend = FALSE)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_y_continuous() +
  scale_x_date(date_breaks = "1 month") +
  facet_wrap(~ region, scales="free")

ggplot(event_intervals_curr %>% filter(region %in% c("US", "Canada")), aes(x=local_date, y=days_between)) +
  geom_bar(stat="identity", position="dodge", aes(fill=group.localized_location)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_y_continuous() +
  scale_x_date(date_breaks = "1 month")

ggplot(event_intervals_curr %>% filter(region=="Europe"), aes(x=local_date, y=days_between)) +
  geom_bar(stat="identity", position="dodge", aes(fill=group.localized_location)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_y_continuous() +
  scale_x_date(date_breaks = "1 month")

ggplot(event_intervals_curr %>% filter(region %in% c("Australia", "Asia", "Africa")), aes(x=local_date, y=days_between)) +
  geom_bar(stat="identity", position="dodge", aes(fill=group.localized_location)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_y_continuous() +
  scale_x_date(date_breaks = "1 month")

ggplot(event_intervals_curr %>% filter(region=="America"), aes(x=local_date, y=days_between)) +
  geom_bar(stat="identity", position="dodge", aes(fill=group.localized_location)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_y_continuous() +
  scale_x_date(date_breaks = "1 month")

```

```{r event_interval_summary}

event_intervals_summary <- event_intervals_curr %>%
  group_by(group.name) %>%
  mutate(num_meetups = n()) %>%
  filter(!is.na(days_between)) %>%
  mutate(days_between_log = round(log(as.numeric(days_between + 1)))) %>%
  group_by(days_between_log) %>%
  mutate(days_between_min_max = ifelse(min(days_between) == max(days_between), 
                                 paste(min(days_between)),
                                 paste(min(days_between), "-", max(days_between)))) %>%
  group_by(group.name, days_between_log) %>%
  summarise(
    days_between_freq = n(),
    days_between_min = min(days_between),
    days_between_max = max(days_between),
    num_meetups = first(num_meetups),
    days_between_min_max = first(days_between_min_max),
    location = first(group.localized_location),
    region = first(region)
  )

# TODO freq % -> # meetups in days between bucket / total # meetups

# which.max just returns one row, we want all max rows
event_intervals_summary_top <- event_intervals_summary %>%
  group_by(group.name) %>%
  slice(which(days_between_freq == max(days_between_freq)))
```

```{r event_interval_summary_plot}

event_intervals_summary_top <- event_intervals_summary_top %>%
  mutate(days_between_min_max=)

ggplot(event_intervals_summary_top, aes(x=reorder(location, num_meetups), y=reorder(days_between_min_max, days_between_log))) +
  geom_bar(stat="identity", position="dodge", aes(fill=region)) +
  coord_flip()
  

```



# Upcoming Meetups

### Upcoming Events Endpoint vs Fetch per Group

The Upcoming Events endpoint appears to be pretty limited in what it returns.

```{r upcoming_vs_future, message=FALSE, warning=FALSE}

meetup_events_upcoming <- read_csv(paste(params$output_folder, "rladies_meetup_upcoming_events.csv", sep="/"))
meetup_events_upcoming <- meetup_events_upcoming %>% mutate(id=as.character(id))

meetup_events_current <- read_csv(paste(params$output_folder, "rladies_meetup_events_current.csv", sep="/"))

meetup_events_missing <- meetup_events_current %>% anti_join(meetup_events_upcoming, by="id") %>% unique()

meetup_events_missing %>% arrange(local_date) %>% select(group.name, name, local_date)

```

### Missing Groups

The upcoming_events endpoint could be useful as a check for any groups that were missed via the find groups endpoint. This should be zero, but if anything shows up, it could be worth double checking the group!

```{r missing_groups, message=FALSE}
meetup_events_current <- read_csv(paste(params$output_folder, "rladies_meetup_events_current.csv", sep="/"))
meetup_events_upcoming <- read_csv(paste(params$output_folder, "rladies_meetup_upcoming_events.csv", sep="/"))

meetup_events_current <- meetup_events_current %>% mutate(id=as.character(id))
meetup_events_upcoming <- meetup_events_upcoming %>% mutate(id=as.character(id))

not_in_groups <- meetup_events_upcoming %>% anti_join(meetup_events_current, by="id")

# check group id
missing_groups <- meetup_events_upcoming %>% anti_join(meetup_groups, by=c("group.name"="name")) 

missing_groups

```

# Membership

How can we best determine Meetup membership? While counting members may not be the best estimate, considering RSVP's may shed more light on this. Not everyone who RSVP's actually shows up, so we may want to look at RSVP trends to determine a better way to adjust the count. 

## RSVP Frequency

How many people RSVP to the meetups?

```{r, past_rsvp_summary}
past_rsvps <- meetup_events_past_merge %>%
  group_by(group.name) %>%
  mutate(
    yes_rsvp_pct = round(yes_rsvp_count/members, 2), # Problem: based on current membership, not membership at the time
    yes_rsvp_log = round(log(yes_rsvp_count)),
    event_month=month(created, label=TRUE),
    event_ym=format(created, "%Y-%m-01") # TODO use lubridate
  ) %>%
  group_by(group.name, yes_rsvp_log) %>%
  mutate(yes_rsvp_log_freq = n()) %>%
  ungroup() %>%
  group_by(group.name, yes_rsvp_pct) %>%
  mutate(yes_rsvp_pct_freq = n())

past_rsvp_summary <- past_rsvps %>% 
  group_by(event_ym, group.name) %>%
  summarise(yes_rsvp_sum_grp=sum(yes_rsvp_count), region=first(region))
```

```{r past_rsvp_summary_plot}

ggplot(past_rsvp_summary, aes(x=event_ym, y=yes_rsvp_sum_grp)) +
  geom_bar(stat="identity", aes(fill=region))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```


```{r past_rsvp_freq, message=FALSE}

past_rsvp_freq <- past_rsvps %>% 
  group_by(group.name) %>% 
  summarize(num_events=n(),
            rsvps_sum = sum(yes_rsvp_count),
            rsvps_med = round(median(yes_rsvp_count)),
            rsvps_min = min(yes_rsvp_count),
            rsvps_max = max(yes_rsvp_count),
            rsvps_mode = yes_rsvp_log[which.max(yes_rsvp_log_freq)],
            rsvps_pct_mode = yes_rsvp_pct[which.max(yes_rsvp_pct_freq)],
            lat=first(group.lat), lon=first(group.lon), 
            location=first(group.localized_location),
            country=first(country),
            state=first(state),
            city=first(city),
            members=first(members),
            region=first(region)) %>%
  mutate(location=reorder(location, -members))
```

```{r past_rsvp_freq_plot}

ggplot(past_rsvp_freq, aes(x=location, y=rsvps_pct_mode)) +
  geom_bar(stat="identity", aes(fill=region)) + 
  coord_flip()

```

## RSVPs per Meetup

Overall RSVPS per Meetup per group (over time)

```{r rsvps_per_meetup}

past_rsvps_month_curr <- past_rsvps %>%
  filter(str_detect(local_date, "2017")) # TODO can we use lubridate here?

ggplot(past_rsvps_month_curr, aes(x=event_month, y=yes_rsvp_count)) +
  geom_bar(stat="identity", position="dodge", aes(fill=group.localized_location), show.legend = FALSE) +
  facet_wrap(~ region, scales="free")

ggplot(past_rsvps_month_curr %>% filter(region %in% c("US", "Canada")), aes(x=event_month, y=yes_rsvp_count)) +
  geom_bar(stat="identity", position="dodge", aes(fill=group.localized_location))

ggplot(past_rsvps_month_curr %>% filter(region=="Europe"), aes(x=event_month, y=yes_rsvp_count)) +
  geom_bar(stat="identity", position="dodge", aes(fill=group.localized_location))

ggplot(past_rsvps_month_curr %>% filter(region %in% c("Australia", "Asia", "Africa")), aes(x=event_month, y=yes_rsvp_count)) +
  geom_bar(stat="identity", position="dodge", aes(fill=group.localized_location))

ggplot(past_rsvps_month_curr %>% filter(region=="America"), aes(x=event_month, y=yes_rsvp_count)) +
  geom_bar(stat="identity", position="dodge", aes(fill=group.localized_location))

```

Percent RSVPs - depends on total membership which only reports an overall total, not the total at the time of the event.

```{r rsvps_pct_per_meetup}

ggplot(past_rsvps_month_curr, aes(x=event_month, y=yes_rsvp_pct)) +
  geom_bar(stat="identity", position="dodge", aes(fill=group.localized_location), show.legend = FALSE) +
  facet_wrap(~ region, scales="free")

ggplot(past_rsvps_month_curr %>% filter(region %in% c("US", "Canada")), aes(x=event_month, y=yes_rsvp_pct)) +
  geom_bar(stat="identity", position="dodge", aes(fill=group.localized_location))

ggplot(past_rsvps_month_curr %>% filter(region=="Europe"), aes(x=event_month, y=yes_rsvp_pct)) +
  geom_bar(stat="identity", position="dodge", aes(fill=group.localized_location))

ggplot(past_rsvps_month_curr %>% filter(region %in% c("Australia", "Asia", "Africa")), aes(x=event_month, y=yes_rsvp_pct)) +
  geom_bar(stat="identity", position="dodge", aes(fill=group.localized_location))

ggplot(past_rsvps_month_curr %>% filter(region=="America"), aes(x=event_month, y=yes_rsvp_pct)) +
  geom_bar(stat="identity", position="dodge", aes(fill=group.localized_location))

```


## RSVP Density

Member RSVP Density per group (how often to members repeatedly RSVP)

## RSVP Proportion

% of events RSVP'ed per member -> rounded and summed - 1/1 = 1, 3/6 = .5, 4/4 = 1

^^ filter low # meetups

## Membership vs RSVPs

How do # members compare to RSVP patterns?

# Conclusions

## Proposed Metrics

### Needs Topic

Identify R-Ladies Meetups that are not using the R-Ladies topics so we can ask them to add it to their Meetup.

### Meetup Event Interval

### Meetup Event Frequency

### Upcoming Meetups

A list/report of upcoming meetups

### Membership Density

While it won't give us an accurate number of members, it will show changes over time




