---
title: "R-Ladies Meetups"
author: "Augustina Ragwitz"
date: "November 20, 2017"
output: html_document
params:
  meetup_api_key: !r Sys.getenv("API_KEY_MEETUP")
  archive_folder: !r Sys.Date()
  output_folder: "latest"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(ggmap)
library(httr)
library(jsonlite)
library(maps)
library(purrr)
library(reshape2)
library(stringr)
library(tidyr)
```

```{r globals}
dir.create(file.path(params$output_folder))

get_meetups <- function (url, query) {
  req <- GET(url, query=query)
  print(paste(req$url))
  json <- content(req, as = "text")
  things <- fromJSON(json, flatten=TRUE)
  return(things)
}
```


# Overview

R-Ladies has developed a package called MeetupR to streamline Meetup analysis. The goal of this notebook is to call the Meetup API directly to document API calls and parameters, then compare the results to the MeetupR implementation. If there are possible improvements then patches will be proposed!

Additionally it would be great to have a dynamic dashboard that shows Meetup stats so we can get the latest and greatest for conference presentations.

## Repo Link

https://github.com/rladies-pdx/meetup-analysis

# Meetup Groups

Identifying Meetup groups should be straightforward because R-Ladies exists as a Meetup topic. Unfortunately not every group is using this topic. This uses the "find_groups" function from the Meetup API.

```{r find_groups}

get_rladies_groups <- function (folder) {
  
  groups_url <- "https://api.meetup.com/find/groups"

  groups_query_params <- list(
    key=params$meetup_api_key, 
    sign=TRUE,
    page=200,
    radius="global")
  
  # by topic
  meetup_groups_topic <- get_meetups(groups_url, append(groups_query_params, c(topic_id=1513883, order="members")))
  
  # by text + category
  meetup_groups_text <- get_meetups(groups_url, append(groups_query_params, c(text="r-ladies", category=34)))
  
  meetup_groups_aggr <- bind_rows(meetup_groups_topic, meetup_groups_text %>% anti_join(meetup_groups_topic, by="id"))
  meetup_groups <- meetup_groups_aggr %>% filter(str_detect(name, "[Rr]([ -]?)[Ll]adies"))
  
  meetup_groups <- meetup_groups %>%
    mutate(events_url = paste("https://api.meetup.com/", urlname, "/events", sep="")) %>%
    select(-meta_category.category_ids) # csv writer thinks this is a list
  
  write.csv(meetup_groups, paste(folder, "rladies_meetup_groups.csv", sep="/"), row.names = FALSE, na = "")
  write.csv(meetup_groups_topic %>% select(-meta_category.category_ids), 
            paste(folder, "rladies_meetup_groups_topic.csv", sep="/"), 
            row.names = FALSE, na = "")
  write.csv(meetup_groups_text %>% select(-meta_category.category_ids), 
            paste(folder, "rladies_meetup_groups_text.csv", sep="/"), 
            row.names = FALSE, na = "")
}



```

```{r meetup_groups}

meetup_groups <- read.csv(paste(params$output_folder, "rladies_meetup_groups.csv", sep="/"),
                                stringsAsFactors = FALSE)

```


## Topic R-Ladies

```{r find_group_by_topic}
meetup_groups_topic <- read.csv(paste(params$output_folder, "rladies_meetup_groups_topic.csv", sep="/"),
                                stringsAsFactors = FALSE)
```


## Text search "R-Ladies"

A text search for "rladies" did not return any results. Including the tech category id (34) excludes extra results.

```{r find_group_by_text}
meetup_groups_text <- read.csv(paste(params$output_folder, "rladies_meetup_groups_text.csv", sep="/"),
                                stringsAsFactors = FALSE)
```

## R-Ladies Missing Topic

Naughty groups!

```{r groups_missing_topic}

# group + organizer to contact
meetups_missing_topic <- meetup_groups_text %>% anti_join(meetup_groups_topic, by="id")

meetups_missing_topic %>% filter(str_detect(name, "[Rr]([ -]?)[Ll]adies")) %>%
  arrange(-members) %>% 
  select(name, localized_location, organizer.name, members, created)

```


## Proposed Metric - Need Topic

Identify R-Ladies Meetups that are not using the R-Ladies topics so we can ask them to add it to their Meetup.

# Meetup Activity

Identifying which groups are regularly scheduling Meetups will help us to see who is the most active. Groups with gaps in Meetup activity or with no events should be highlighted so we can reach out to their organizers. 

## Past Events

```{r group_events_past}

get_rladies_past <- function (folder) {
  meetup_groups <- read.csv(paste(folder, "rladies_meetup_groups.csv", sep="/"))
  
  past_events_query_params <- list(
    key=params$meetup_api_key, 
    sign=TRUE,
    page=200,
    status="past",
    fields=paste("comment_count", "photo_album", sep=", ")
  )
  
  dir.create(file.path(paste(folder, "rladies_meetup_events", sep="/")))
  
  meetup_events_past <- data_frame()
  
  for (n in 1:nrow(meetup_groups)) {
    events_url <- meetup_groups[n,]["events_url"]
    print(paste("Trying url:", events_url$events_url))
    meetups <- get_meetups(events_url$events_url, past_events_query_params)
    if(length(meetups)== 0) {
      next()
    }
  
    meetups <- meetups %>% mutate(photo_album.photo_sample=NA)
    meetup_events_past <- bind_rows(meetup_events_past, meetups)
    write.csv(meetup_events_past, paste0(folder, "/rladies_meetup_events/_meetup_events_past_", n, ".csv"),
              row.names = FALSE, na = "")
  }
  
  
  write.csv(meetup_events_past, paste(folder,"rladies_meetup_events_past.csv", sep="/"), 
            row.names = FALSE, na = "")
}

```

```{r read_past_events}
meetup_events_past <- read.csv(paste(params$output_folder,"rladies_meetup_events_past.csv", sep="/"),
                               stringsAsFactors = FALSE)

meetup_groups <- read.csv(paste(params$output_folder, "rladies_meetup_groups.csv", sep="/"),
                                stringsAsFactors = FALSE)

meetup_events_past_merge <- meetup_events_past %>% 
  inner_join(meetup_groups %>% 
               select(urlname, city, country, state, members, timezone),
             by=c("group.urlname"="urlname")) %>%
  separate(timezone, c("region"), extra="drop", fill="left") %>%
  mutate(group.created=as.POSIXct(group.created/1000, origin="1970-01-01"))
```


## Event Frequency

How many events has each meetup had?

```{r past_events_freq}
past_events_freq <- meetup_events_past_merge %>% 
  group_by(group.name) %>% 
  summarise(num_events=n(),
            lat=first(group.lat), lon=first(group.lon), 
            location=first(group.localized_location),
            country=first(country),
            state=first(state),
            city=first(city),
            members=first(members),
            region=first(region)) %>%
  mutate(num_events_log = round(log(num_events))) %>%
  group_by(num_events_log) %>%
  mutate(events_min_max = ifelse(min(num_events) == max(num_events), 
                                 paste(min(num_events)),
                                 paste(min(num_events), "-", max(num_events))))

```

```{r past_events_freq_hist}

ggplot(past_events_freq, aes(x=reorder(location, num_events), y=num_events)) +
  geom_bar(stat="identity", aes(fill=region)) +
  coord_flip()

```

```{r past_events_freq_map}
ggplot(data=past_events_freq, 
       aes(x=lon, y=lat, size=num_events_log, colour=reorder(events_min_max, num_events_log))) +
  borders("world", colour="gray50", fill="gray50") +
  geom_point() +
  scale_color_discrete(name="Events") +
  scale_size_continuous(guide=FALSE)

ggplot(data=past_events_freq %>% filter(region=="US"), 
       aes(x=lon, y=lat, size=num_events_log, colour=reorder(events_min_max, num_events_log))) +
  borders("usa", colour="gray50", fill="gray50") +
  geom_point() +
  scale_color_discrete(name="Events") +
  scale_size_continuous(guide=FALSE)

ggplot(data=past_events_freq %>% filter(region=="Europe"), 
       aes(x=lon, y=lat, size=num_events_log, colour=reorder(events_min_max, num_events_log))) +
  borders("world", colour="gray50", fill="gray50", xlim = c(-20, 59), ylim = c(35, 71)) +
  geom_point() +
  scale_color_discrete(name="Events") +
  scale_size_continuous(guide=FALSE)
```

## Event Frequency Density

```{r}
ggplot(past_events_freq, aes(x=reorder(events_min_max, num_events_log))) + 
  geom_density() +
  xlab("Events per Meetup (Log)")
```



## Meetup Age by First Event

What is the "age" of meetups based on their first event?

```{r, message=FALSE, warning=FALSE}

past_event_age <- meetup_events_past_merge %>%
  group_by(group.name) %>%
  summarise(first_meetup = min(local_date, na.rm=FALSE),
            location=first(group.localized_location),
            region=first(region),
            group.created=first(group.created)) %>%
  mutate(first_meetup=ifelse(first_meetup=="", NA, first_meetup),
         first_meetup_age=ceiling(as.numeric(difftime(as.Date("2017-12-01"), first_meetup, units="days"))),
         location=reorder(location, first_meetup_age))

ggplot(past_event_age, aes(x=location, y=first_meetup_age)) +
  geom_bar(stat="identity", aes(fill=region)) +
  coord_flip()

```

## First Meetup vs Created

```{r, message=FALSE, warning=FALSE}
created_vs_first <- past_event_age %>%
  mutate(
    group_age = ceiling(as.numeric(difftime(as.Date("2017-12-01"), group.created, units="days"))),
    created_interval=ceiling(as.numeric(difftime(first_meetup, group.created, units="days"))),
    location=reorder(location, -created_interval))

ggplot(created_vs_first, aes(x=location, y=created_interval)) +
  geom_bar(stat="identity", aes(fill=region)) +
  coord_flip()

```

```{r, message=FALSE, warning=FALSE}
created_vs_first_melt <- created_vs_first %>% 
  mutate(location=reorder(location,group_age)) %>%
  select(location, group_age, created_interval) %>% 
  melt()

ggplot(created_vs_first_melt, aes(x=location, y=value)) +
  geom_bar(stat="identity", aes(fill=variable)) +
  coord_flip()
```

## Event RSVPs

How many people RSVP to the meetups?

```{r, message=FALSE}
past_rsvps <- meetup_events_past_merge %>%
  group_by(group.name) %>%
  mutate(
    yes_rsvp_pct = round(yes_rsvp_count/members, 2),
    yes_rsvp_log = round(log(yes_rsvp_count))
  ) %>%
  group_by(group.name, yes_rsvp_log) %>%
  mutate(yes_rsvp_log_freq = n()) %>%
  ungroup() %>%
  group_by(group.name, yes_rsvp_pct) %>%
  mutate(yes_rsvp_pct_freq = n())

past_rsvp_freq <- past_rsvps %>% 
  group_by(group.name) %>% 
  summarize(num_events=n(),
            rsvps_sum = sum(yes_rsvp_count),
            rsvps_med = round(median(yes_rsvp_count)),
            rsvps_min = min(yes_rsvp_count),
            rsvps_max = max(yes_rsvp_count),
            rsvps_mode = yes_rsvp_log[which.max(yes_rsvp_log_freq)],
            rsvps_pct_mode = yes_rsvp_pct[which.max(yes_rsvp_pct_freq)],
            lat=first(group.lat), lon=first(group.lon), 
            location=first(group.localized_location),
            country=first(country),
            state=first(state),
            city=first(city),
            members=first(members),
            region=first(region)) %>%
  mutate(location=reorder(location,members))

ggplot(past_rsvp_freq, aes(x=location, y=rsvps_pct_mode)) +
  geom_bar(stat="identity") + 
  coord_flip()
```


## Event Interval

How much time passes between the Meetup events? Are some groups regularly meeting every month? What is the typical time interval between Meetup groups?

## Proposed Metric - Meetup Event Interval

## Proposed Meetup - Meetup Event Frequency

# Upcoming Meetups

```{r group_events_future}

get_rladies_future <- function (folder) {
  meetup_groups <- read.csv(paste(params$output_folder, "rladies_meetup_groups.csv", sep="/"))
  
  future_events_query_params <- list(
    key=params$meetup_api_key, 
    sign=TRUE,
    page=200,
    status="upcoming",
    fields=paste("comment_count", "photo_album", sep=", ")
  )
  
  dir.create(file.path(paste(folder, "rladies_meetup_events", sep="/")))
  
  meetup_events_future <- data_frame()
  
  for (n in 1:nrow(meetup_groups)) {
    events_url <- meetup_groups[n,]["events_url"]
    print(paste("Trying url:", events_url$events_url))
    meetups <- get_meetups(events_url$events_url, future_events_query_params)
  
    if(length(meetups)== 0) {
      next()
    }
  
    meetups <- meetups %>% mutate(photo_album.photo_sample=NA)
    meetup_events_future <- bind_rows(meetup_events_future, meetups)
    write.csv(meetup_events_future, 
              paste0(folder, "/rladies_meetup_events/_meetup_events_future_", n, ".csv"),
              row.names = FALSE, na = "")
  }
  
  write.csv(meetup_events_future, paste(folder, "rladies_meetup_events_future.csv", sep="/"), 
            row.names = FALSE, na = "")
}
```

### Upcoming Events Endpoint

Meetup provides an upcoming_events endpoint that is convenient but may not be comprehensive. Let's use it and compare our results to the group by group approach above.

```{r upcoming_events}

get_rladies_upcoming <- function (folder) {
  find_upcoming_url <- "https://api.meetup.com/find/upcoming_events"
  
  # change to get upcoming meetups for all meetups in the list
  events_query_params <- list(
    key=params$meetup_api_key, 
    sign=TRUE,
    page=200,
    order="time",
    radius="global")
  
  get_group_events <- function (url, query) {
    req <- GET(url, query=query)
    print(paste(req$url))
    json <- content(req, as = "text")
    groups <- fromJSON(json, flatten=TRUE)
    return(groups$events)
  }
  
  # I tried "topic" but no R-Ladies results were returned, so this field doesn't apply
  meetup_events_text <- get_group_events(find_upcoming_url, append(events_query_params, c(text="rladies")))
  
  # just in case anything slipped in there
  meetup_events_upcoming <- meetup_events_text %>% filter(str_detect(group.name, "[Rr](-?)[Ll]adies"))
                                            
  write.csv(meetup_events_upcoming, paste(folder, "rladies_meetup_upcoming_events.csv", sep="/"), 
            row.names = FALSE, na = "")
}

```

### Upcoming Events Endpoint vs Fetch per Group

The Upcoming Events endpoint appears to be pretty limited in what it returns.

```{r upcoming_vs_future}

meetup_events_upcoming <- read.csv(paste(params$output_folder, "rladies_meetup_upcoming_events.csv", sep="/"),
                                   stringsAsFactors = FALSE)
meetup_events_upcoming <- meetup_events_upcoming %>% mutate(id=as.character(id))

meetup_events_future <- read.csv(paste(params$output_folder, "rladies_meetup_events_future.csv", sep="/"),
                                   stringsAsFactors = FALSE)
meetup_events_future <- meetup_events_future %>% mutate(id=as.character(id))

meetup_events_missing <- meetup_events_future %>% anti_join(meetup_events_upcoming, by="id") %>% unique()

meetup_events_missing %>% arrange(local_date) %>% select(group.name, name, local_date)

```

### Missing Groups

The upcoming_events endpoint could be useful as a check for any groups that were missed via the find groups endpoint. This should be zero, but if anything shows up, it could be worth double checking the group!

```{r missing_groups}
meetup_events_future <- read.csv(paste(params$output_folder, "rladies_meetup_events_future.csv", sep="/"), 
                                 stringsAsFactors = FALSE)
meetup_events_upcoming <- read.csv(paste(params$output_folder, "rladies_meetup_upcoming_events.csv", sep="/"),
                                   stringsAsFactors = FALSE)

meetup_events_future <- meetup_events_future %>% mutate(id=as.character(id))
meetup_events_upcoming <- meetup_events_upcoming %>% mutate(id=as.character(id))

not_in_groups <- meetup_events_upcoming %>% anti_join(meetup_events_future, by="id")

# check group id
missing_groups <- meetup_events_upcoming %>% anti_join(meetup_groups, by=c("group.name"="name")) 

missing_groups

```

## Proposed Metric - Upcoming Meetups

A list/report of upcoming meetups

# Membership

How can we best determine Meetup membership? While counting members may not be the best estimate, considering RSVP's may shed more light on this. Not everyone who RSVP's actually shows up, so we may want to look at RSVP trends to determine a better way to adjust the count. 

## RSVPs per Meetup

Overall RSVPS per Meetup per group (over time)

## RSVP Density

Member RSVP Density per group (how often to members repeatedly RSVP)

## RSVP Proportion

% of events RSVP'ed per member -> rounded and summed - 1/1 = 1, 3/6 = .5, 4/4 = 1
^^ filter low # meetups

## Membership vs RSVPs

How do # members compare to RSVP patterns?

## Proposed Metric - Membership Density

While it won't give us an accurate number of members, it will show changes over time

# Characteristics of High Membership Meetups

Considering the proposed metrics, what features do more "successful" Meetups have? Maybe this could serve as a guide for Meetup organizers!

## Meeting Frequency

## RSVP Trends

## Relationship to City Demographics

# Appendix

## Latest

Create a new archive folder and get the latest data.

```{r get_latest_data, eval=FALSE}

dir.create(file.path(params$archive_folder))

# TODO add try/catch for throttling
get_rladies_groups(params$archive_folder)
get_rladies_past(params$archive_folder)
get_rladies_upcoming(params$archive_folder)
get_rladies_future(params$archive_folder)

system2("rm", args = c(params$output_folder))
system2("cp", args = c("-R", params$archive_folder, params$output_folder))

```




